<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>html,body{height:100%;margin:0}#map{position:fixed;inset:0}</style>
  <title>OneStep Map</title>
</head>
<body>
  <div id="map"></div>
  <script>
    const map = L.map('map', { zoomControl:true }).setView([35.115,129.040],16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    map.on('click', (e) => {
      const msg = JSON.stringify({ type:'click', lat:e.latlng.lat, lng:e.latlng.lng });
      if (window.ReactNativeWebView) window.ReactNativeWebView.postMessage(msg); else console.log(msg);
    });

    let routeLine=null;
    window.drawRoute=(pts)=>{
      try{
        if(routeLine) map.removeLayer(routeLine);
        if(!Array.isArray(pts)||pts.length===0) return;
        const latlngs=pts.map(p=>[p.lat,p.lng]);
        routeLine=L.polyline(latlngs,{weight:5,color:'#1e73ff'}).addTo(map);
        map.fitBounds(routeLine.getBounds(),{padding:[32,32]});
      }catch(e){console.error(e)}
    };

    let myMarker=null;
    window.setMyLocation=(lat,lng,center=true)=>{
      if(myMarker) myMarker.remove();
      myMarker=L.marker([lat,lng]).addTo(map);
      if(center) map.setView([lat,lng],Math.max(17,map.getZoom()),{animate:true});
    };
    window.clearMyLocation=()=>{ if(myMarker){ myMarker.remove(); myMarker=null; } };

    // 회피 사각형
    let rectLayers=[];
    window.drawAvoidRects=(rects)=>{
      rectLayers.forEach(l=>map.removeLayer(l)); rectLayers.length=0;
      if(!Array.isArray(rects)) return;
      rects.forEach(r=>{
        const half=r.side/2;
        const dLat = half/111320;
        const dLng = half/(111320*Math.cos(r.lat*Math.PI/180));
        const bounds=[[r.lat-dLat,r.lng-dLng],[r.lat+dLat,r.lng+dLng]];
        const layer=L.rectangle(bounds,{color:'#ff3b30',weight:2,fillColor:'#ff3b30',fillOpacity:0.25}).addTo(map);
        rectLayers.push(layer);
      });
    };

    // 채택된 우회 웨이포인트(파란 점)
    let wpLayers=[];
    window.drawBypassWps=(wps)=>{
      wpLayers.forEach(l=>map.removeLayer(l)); wpLayers.length=0;
      if(!Array.isArray(wps)) return;
      wps.forEach(p=>{
        const l=L.circleMarker([p.lat,p.lng],{radius:4,color:'#0076ff',weight:2,fillColor:'#0076ff',fillOpacity:0.9}).addTo(map);
        wpLayers.push(l);
      });
    };

    if (window.ReactNativeWebView) {
      window.ReactNativeWebView.postMessage(JSON.stringify({ type:'ready' }));
    }
  </script>
</body>
</html>
